# General Overview

* This document is intended as guidance for Co-Pilot.
* The application name is "Monkey Hi Hat" and is also referred to as "MHH" or "Monkey-Hi-Hat".
* The solution contains the MHH project, an installer project, and content used to test the application.
* This document is primarily concerned with the MHH project.
* Unit-testing is not implemented or desired for this project.
* The folder structure is organizational and does not reflect namespaces.
* There is no special build process; the solution can be built directly in Visual Studio.
* The purpose of the application is to display abstract graphics, many of which are audio-reactive.
* Graphics are generated by various combinations of OpenGL shaders.
* Supported shaders are visualizations (viz), post-processing effects (FX), crossfades, and function libraries.
* Shaders are written in OpenGL 4.5's GLSL shader language via support from the OpenTK library and the eyecandy library.
* The eyecandy library processes audio data into OpenGL textures which are then used by the shaders.
* The configuration file 'mhh.conf' contains all application settings and explanatory comments.
* For development purposes, the configuration file 'mhh-dev.conf' will be used, which is a simplified version of 'mhh.conf'.
* Co-Pilot can recommend additions or changes to this document to improve its ability to understand the application.
* MHH is a modern .NET application currently using .NET 8.
* The installer is a .NET Framework application because .NET Framework 4.8 is automatically available on Windows.

# Project Metadata

* ProjectName: Monkey Hi Hat
* Aliases: MHH, Monkey-Hi-Hat
* MainTargetFramework: .NET 8
* InstallerTargetFramework: .NET Framework 4.8
* Platform: Windows
* UI: Console with non-interactive graphics window
* AudioLibrary: eyecandy
* ShaderLibrary: eyecandy
* GraphicsLibrary: OpenTK
* ShaderLanguage: GLSL 4.5
* UnitTesting: Disabled
* BuildProcess: Standard Visual Studio IDE build and publish

# Directory Purpose

* ConfigFiles/ : Application and development configuration templates
* Hosting/ : Main window, config file support, management of playlists and test mode
* InternalShaders/ : Essential shaders always available
* Rendering/ : Shader and texture loading, shader execution, and render pipeline management
* Utils/Caching/ : Shader and library caching
* Utils/Global/ : Constants, enums, logging, path utilities
* Utils/OpenGL/ : OpenGL resource and texture management
* VertexSources/ : Vertex source interfaces and implementations

# Discussion of Project Structure and Content

* Program.cs in the top-level directory is the main entry point for the application. It loads application configuration, checks for other running instances (and passes command-line switches to them when found), or launches the application either actively or in standby (according to config). It also handles basic command-line switch parsing, although HostWindow.cs actually performs most operations requested by command-line switches.
* The ConfigFiles directory stores the full template "mhh.conf" file and the dev/debug-oriented "mhh-dev.conf" file.
* The Hosting directory stores the HostWindow.cs file, which is the main window of the application, and various files used to read and store application configuration, playlists, and shader configurations. The PlaylistManager.cs file manages playlists and their content, and TestModeManager.cs manages test mode operations, which is used to test new viz or FX shaders running combined with existing viz or FX shaders.
* The InternalShaders directory contains utility shaders that are always required and used often, such as text overlay support, a basic crossfade, passthrough shaders, and a simple default idle shader guaranteed to always be available.
* The Rendering directory contains a RenderingManager.cs file, which handles loading, execution, control, and unloading of shaders and the rendering pipeline. The RenderingHelper.cs file provides utility functions for rendering operations, such as loading textures, videos, and managing shader programs. Specific rendering classes like VizShader.cs, FXShader.cs, and CrossfadeShader.cs define the behavior of different shader types. Also present are classes for generating screenshots, and multi-pass shader config parsing and support.
* The Utils/Caching directory contains classes for caching compiled shaders and shader libraries.
* The Utils/Global directory contains files defining constants, enums, extensions, and utilities to support logging and path handling.
* The Utils/OpenGL directory contains classes focused on OpenGL resource management. GLImageTexture.cs is a simple data storage class defining static images or video files. The program uses the concept of a "resource group" which can include OpenGL framebuffer objects (FBOs) and textures. GLResourceGroup is a simple data storage class that defines one of these OpenGL resources stored within a resource group. GLResourceManager.cs manages these resource groups, allowing for easy creation, retrieval, and disposal of OpenGL resources. The VideoMediaData.cs class is a simple data storage class defining characteristics of a video file, which is attached to a GLImageTexture object when the texture comes from video playback.
* The VertexSources directory defines the IVertexSource interface and two implementations. VertexIntegerArray.cs is for shaders generate imagery using OpenGL primtives such as lines and triangle strips. Generally these will use a custom vertex shader and a passthrough fragment shader. VertexQuad.cs is for shaders that use a full-screen quad, which is the most common type of shader used in MHH. These shaders normally use the passthrough vertex shader and a custom fragment shader.

# Operation

* The application is a console program that has no user interface.
* When running, the application is controlled by command-line arguments sent from another instance in another terminal.
* An optional companion Windows Service application called "Monkey See Monkey Do" (MSMD) is used to launch the MHH application if it is not already running.
* The application recognizes various keystrokes for controllling the content, exiting, and similar operations.
* The application can also accept command-line arguments over TCP/IP via either SSH or a dedicated remote control program.
* Although it is possible to manually start a viz, the common use is to load playlists of viz and FX content.
* Viz shaders generate interesting visual effects, often audio-reactive.
* FX shaders are post-processing effects applied to the output of viz shaders.
* FX shaders can be explicitly specified with a viz shader, or applied randomly according to settings in the playlist.
* Crossfade shaders are used to transition between viz shaders, including any FX already applied to the viz.
* A text-overlay shader can be used to display statistical data, shader names and descriptions, or music track information.
* Music track information is only available under Windows when the native Spotify client is running.
* Audio data is processed by the eyecandy library, which provides OpenGL textures to the shaders in various formats.
* Shader config files can specify static images or video files which will be provided to the shader as OpenGL textures.
* Although it would be possible to create 3D shaders, the application is primarily focused on 2D shaders.

# Shader Content

* For installed usage, shader content comes from an external repository.
* The application is able to search multiple paths for shader content. Paths are specified in the configuration file.
* Most content has a config file, a "vert" file with the OpenGL vertex shader, and a "frag" file with the OpenGL fragment shader. Many shaders will use either a default (or "passthrough") vertex or fragment shader.
* Viz and FX shaders can be multi-pass, in which shader output buffers are used as inputs to other shaders to produce the final output texture.

# Shader File Structure

* Each shader consists of:
  - <name>.conf : Configuration file
  - <name>.vert : Vertex shader (GLSL 4.5)
  - <name>.frag : Fragment shader (GLSL 4.5)
* Multi-pass shaders may include additional config sections for buffer chaining.
* Default shaders: passthrough.vert, passthrough.frag

# AI Integration Guidance

* The main entry point is Program.cs, which initializes the application, loads configuration, and manages single-instance execution via named pipes.
* All runtime commands are processed as command-line switches and routed to HostWindow for execution.
* Application configuration is loaded from mhh.conf (or mhh.debug.conf for development) and parsed into ApplicationConfiguration, which is globally accessible.
* Shader, playlist, and FX files are discovered using PathHelper and loaded via ConfigFile, VisualizerConfig, and FXConfig.
* The eyecandy library is used for audio capture and processing, providing OpenGL textures for audio-reactive visualizations.
* OpenGL resources are managed by GLResourceManager and related classes in Utils/OpenGL.
* Rendering is orchestrated by RenderManager, supporting multi-pass, crossfade, and post-processing FX shaders.
* All command-line switches and their behaviors are defined in Program.cs; refer to this file for supported operations.
* When generating new code:
  - Use .NET 8 APIs and idioms.
  - Place files according to the directory purpose described above.
  - Integrate with the command-line switch and named pipe architecture.
  - Do not generate unit tests.
  - Use existing helper classes for configuration, path handling, and logging.
